<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nodejs 从 0 到 1 | Belief°</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="https://infinitypro-img.infinitynewtab.com/custom-icon/8001de1jd3n68lbfnxxt564xvb0vl5.png?imageMogr2/thumbnail/240x/format/webp/blur/1x0/quality/100|imageslim">
    <script language="javascript" type="text/javascript" src="https://cdn.staticfile.org/jquery/1.7.2/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="/blog/js/MouseClickEffect.js"></script>
    <meta name="description" content="读一切好书，就是和许多高尚的人谈话。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/blog/assets/css/0.styles.a5361a70.css" as="style"><link rel="preload" href="/blog/assets/js/app.396e683c.js" as="script"><link rel="preload" href="/blog/assets/js/5.e2f1812c.js" as="script"><link rel="preload" href="/blog/assets/js/1.f0d29b0d.js" as="script"><link rel="preload" href="/blog/assets/js/2.c2276c40.js" as="script"><link rel="preload" href="/blog/assets/js/70.3cff71b8.js" as="script"><link rel="preload" href="/blog/assets/js/20.fc7d5e78.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f61ca3f7.js"><link rel="prefetch" href="/blog/assets/js/11.2b895bcf.js"><link rel="prefetch" href="/blog/assets/js/12.6a5774a0.js"><link rel="prefetch" href="/blog/assets/js/13.219a019b.js"><link rel="prefetch" href="/blog/assets/js/14.b8f2d24f.js"><link rel="prefetch" href="/blog/assets/js/15.15d2e655.js"><link rel="prefetch" href="/blog/assets/js/16.eec32ac2.js"><link rel="prefetch" href="/blog/assets/js/17.b3625505.js"><link rel="prefetch" href="/blog/assets/js/18.77a80591.js"><link rel="prefetch" href="/blog/assets/js/19.0ac9ed1d.js"><link rel="prefetch" href="/blog/assets/js/21.3a337d1e.js"><link rel="prefetch" href="/blog/assets/js/22.41ba82bb.js"><link rel="prefetch" href="/blog/assets/js/23.98e3fdd0.js"><link rel="prefetch" href="/blog/assets/js/24.f29da163.js"><link rel="prefetch" href="/blog/assets/js/25.9b1b14d5.js"><link rel="prefetch" href="/blog/assets/js/26.22caa178.js"><link rel="prefetch" href="/blog/assets/js/27.1e2346ba.js"><link rel="prefetch" href="/blog/assets/js/28.da26bcf8.js"><link rel="prefetch" href="/blog/assets/js/29.3bc1e41a.js"><link rel="prefetch" href="/blog/assets/js/30.f061ce57.js"><link rel="prefetch" href="/blog/assets/js/31.8e089ac8.js"><link rel="prefetch" href="/blog/assets/js/32.2f7cc209.js"><link rel="prefetch" href="/blog/assets/js/33.b4e25806.js"><link rel="prefetch" href="/blog/assets/js/34.9a1de734.js"><link rel="prefetch" href="/blog/assets/js/35.4add351d.js"><link rel="prefetch" href="/blog/assets/js/36.47252601.js"><link rel="prefetch" href="/blog/assets/js/37.24e0a9c4.js"><link rel="prefetch" href="/blog/assets/js/38.13f037bd.js"><link rel="prefetch" href="/blog/assets/js/39.2a762ecf.js"><link rel="prefetch" href="/blog/assets/js/40.d28d5120.js"><link rel="prefetch" href="/blog/assets/js/41.f822d218.js"><link rel="prefetch" href="/blog/assets/js/42.ec45cdee.js"><link rel="prefetch" href="/blog/assets/js/43.5cc28333.js"><link rel="prefetch" href="/blog/assets/js/44.62d286b3.js"><link rel="prefetch" href="/blog/assets/js/45.1ecc9d27.js"><link rel="prefetch" href="/blog/assets/js/46.9752875e.js"><link rel="prefetch" href="/blog/assets/js/47.fa4ff9fc.js"><link rel="prefetch" href="/blog/assets/js/48.67cd96e1.js"><link rel="prefetch" href="/blog/assets/js/49.22c8d5dd.js"><link rel="prefetch" href="/blog/assets/js/50.64744687.js"><link rel="prefetch" href="/blog/assets/js/51.1fb8d094.js"><link rel="prefetch" href="/blog/assets/js/52.0ba15dca.js"><link rel="prefetch" href="/blog/assets/js/53.6ca0d9de.js"><link rel="prefetch" href="/blog/assets/js/54.d7c1faa9.js"><link rel="prefetch" href="/blog/assets/js/55.b6982ed4.js"><link rel="prefetch" href="/blog/assets/js/56.0e26c79e.js"><link rel="prefetch" href="/blog/assets/js/57.688fff7a.js"><link rel="prefetch" href="/blog/assets/js/58.093a6666.js"><link rel="prefetch" href="/blog/assets/js/59.8789d4ee.js"><link rel="prefetch" href="/blog/assets/js/6.e4363e17.js"><link rel="prefetch" href="/blog/assets/js/60.dafd0518.js"><link rel="prefetch" href="/blog/assets/js/61.4ceba931.js"><link rel="prefetch" href="/blog/assets/js/62.ac324b8a.js"><link rel="prefetch" href="/blog/assets/js/63.6a08ffa3.js"><link rel="prefetch" href="/blog/assets/js/64.2057ac47.js"><link rel="prefetch" href="/blog/assets/js/65.f2ceba6b.js"><link rel="prefetch" href="/blog/assets/js/66.673d05f1.js"><link rel="prefetch" href="/blog/assets/js/67.5c827a2d.js"><link rel="prefetch" href="/blog/assets/js/68.cbe6dc03.js"><link rel="prefetch" href="/blog/assets/js/69.aa1d4777.js"><link rel="prefetch" href="/blog/assets/js/7.fd0ed7af.js"><link rel="prefetch" href="/blog/assets/js/71.13ff862b.js"><link rel="prefetch" href="/blog/assets/js/72.d0b4c493.js"><link rel="prefetch" href="/blog/assets/js/73.c26296f3.js"><link rel="prefetch" href="/blog/assets/js/74.2722b882.js"><link rel="prefetch" href="/blog/assets/js/75.5bb22334.js"><link rel="prefetch" href="/blog/assets/js/76.d18452b9.js"><link rel="prefetch" href="/blog/assets/js/77.4e6823bb.js"><link rel="prefetch" href="/blog/assets/js/78.0767ca45.js"><link rel="prefetch" href="/blog/assets/js/79.70af94ee.js"><link rel="prefetch" href="/blog/assets/js/8.1f3525fd.js"><link rel="prefetch" href="/blog/assets/js/80.f72c62f5.js"><link rel="prefetch" href="/blog/assets/js/81.41b5f4a2.js"><link rel="prefetch" href="/blog/assets/js/82.180a6bbf.js"><link rel="prefetch" href="/blog/assets/js/9.544a9a3b.js"><link rel="prefetch" href="/blog/assets/js/vendors~flowchart.ebcbdedf.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.a5361a70.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-584a622c><div data-v-584a622c><div id="loader-wrapper" class="loading-wrapper" data-v-c01c9394 data-v-584a622c data-v-584a622c><div class="loader-main" data-v-c01c9394><div data-v-c01c9394></div><div data-v-c01c9394></div><div data-v-c01c9394></div><div data-v-c01c9394></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-73c95a87 data-v-584a622c data-v-584a622c><h3 class="title" style="display:none;" data-v-73c95a87 data-v-73c95a87>Belief°</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-73c95a87 data-v-73c95a87><input type="password" value="" data-v-73c95a87> <span data-v-73c95a87>Konck! Knock!</span> <button data-v-73c95a87>OK</button></label> <div class="footer" style="display:none;" data-v-73c95a87 data-v-73c95a87><span data-v-73c95a87><i class="iconfont reco-theme" data-v-73c95a87></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-73c95a87>vuePress-theme-reco</a></span> <span data-v-73c95a87><i class="iconfont reco-copyright" data-v-73c95a87></i> <a data-v-73c95a87><span data-v-73c95a87>zn</span>
            
          <span data-v-73c95a87>2018 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-584a622c><header class="navbar" data-v-584a622c><div title="导航" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Belief°</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/JavaScript/" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/TypeScript/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/docker/" class="nav-link"><i class="iconfont undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/JavaScript设计模式/" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript设计模式
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/HTML5/" class="nav-link"><i class="iconfont undefined"></i>
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/nodejs/" class="nav-link"><i class="iconfont undefined"></i>
  nodejs
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/项目初始化及构建/" class="nav-link"><i class="iconfont undefined"></i>
  项目初始化及构建
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/http协议/" class="nav-link"><i class="iconfont undefined"></i>
  http协议
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/redux/" class="nav-link"><i class="iconfont undefined"></i>
  redux
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/h5 live/" class="nav-link"><i class="iconfont undefined"></i>
  h5 live
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/webrtc/" class="nav-link"><i class="iconfont undefined"></i>
  webrtc
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/前端面试/" class="nav-link"><i class="iconfont undefined"></i>
  前端面试
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/mongoDB/" class="nav-link"><i class="iconfont undefined"></i>
  mongoDB
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/React/" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vue/" class="nav-link"><i class="iconfont undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/前端工程化/" class="nav-link"><i class="iconfont undefined"></i>
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/小程序/" class="nav-link"><i class="iconfont undefined"></i>
  小程序
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      其它
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Common sites🎈</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://stackoverflow.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Stackoverflow
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://leetcode-cn.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  LeetCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://cn.vuejs.org/v2/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Vue.js
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.bootcdn.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  BootCDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.linuxcool.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Linux命令大全
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.tiobe.com/tiobe-index/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  编程语言排行榜
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link"><i class="iconfont reco-message"></i>
  关于我
</a></div> <a href="https://github.com/Dave-SEO/blog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask" data-v-584a622c></div> <aside class="sidebar" data-v-584a622c><div class="personal-info-wrapper" data-v-7e653f02><img src="/blog/vuepress/head-fish.jpg" alt="author-avatar" class="personal-img" data-v-7e653f02> <h3 class="name" data-v-7e653f02>
    zn
  </h3> <div class="num" data-v-7e653f02><div data-v-7e653f02><h3 data-v-7e653f02>51</h3> <h6 data-v-7e653f02>文章</h6></div> <div data-v-7e653f02><h3 data-v-7e653f02>31</h3> <h6 data-v-7e653f02>标签</h6></div></div> <hr data-v-7e653f02></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/JavaScript/" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/TypeScript/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/docker/" class="nav-link"><i class="iconfont undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/JavaScript设计模式/" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript设计模式
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/HTML5/" class="nav-link"><i class="iconfont undefined"></i>
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/nodejs/" class="nav-link"><i class="iconfont undefined"></i>
  nodejs
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/项目初始化及构建/" class="nav-link"><i class="iconfont undefined"></i>
  项目初始化及构建
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/http协议/" class="nav-link"><i class="iconfont undefined"></i>
  http协议
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/redux/" class="nav-link"><i class="iconfont undefined"></i>
  redux
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/h5 live/" class="nav-link"><i class="iconfont undefined"></i>
  h5 live
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/webrtc/" class="nav-link"><i class="iconfont undefined"></i>
  webrtc
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/前端面试/" class="nav-link"><i class="iconfont undefined"></i>
  前端面试
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/mongoDB/" class="nav-link"><i class="iconfont undefined"></i>
  mongoDB
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/React/" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vue/" class="nav-link"><i class="iconfont undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/前端工程化/" class="nav-link"><i class="iconfont undefined"></i>
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/小程序/" class="nav-link"><i class="iconfont undefined"></i>
  小程序
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      其它
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Common sites🎈</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://stackoverflow.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Stackoverflow
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://leetcode-cn.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  LeetCode
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://cn.vuejs.org/v2/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Vue.js
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.bootcdn.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  BootCDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.linuxcool.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Linux命令大全
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.tiobe.com/tiobe-index/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  编程语言排行榜
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link"><i class="iconfont reco-message"></i>
  关于我
</a></div> <a href="https://github.com/Dave-SEO/blog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>nodejs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/views/nodejs/nodejs从0到1.html" class="active sidebar-link">nodejs 从 0 到 1</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#nodejs-到底是什么" class="sidebar-link">nodejs 到底是什么</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#要实现什么-系统架构图" class="sidebar-link">要实现什么 - 系统架构图</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#项目目录" class="sidebar-link">项目目录</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#nodejs创建服务器" class="sidebar-link">nodejs创建服务器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#服务器创建" class="sidebar-link">服务器创建</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#获取get请求参数" class="sidebar-link">获取GET请求参数</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#获取post请求及参数" class="sidebar-link">获取POST请求及参数</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#处理不同的请求方式" class="sidebar-link">处理不同的请求方式</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#处理不同数据类型" class="sidebar-link">处理不同数据类型</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#express" class="sidebar-link">express</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#express-适合做什么" class="sidebar-link">express 适合做什么</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#创建服务器" class="sidebar-link">创建服务器</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#创建请求方式-以对数据增、改、查为例" class="sidebar-link">创建请求方式(以对数据增、改、查为例)</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#数据持久化存储mongodb" class="sidebar-link">数据持久化存储MongoDB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#mongodb-是什么" class="sidebar-link">MongoDB 是什么</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#mongodb-有哪些特性" class="sidebar-link">MongoDB 有哪些特性</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#mongodb-使用场景" class="sidebar-link">MongoDB 使用场景</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#安装mongodb" class="sidebar-link">安装MongoDB</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#命令" class="sidebar-link">命令</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#mongdb基本增删改查操作" class="sidebar-link">MongDB基本增删改查操作</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#使用node链接mongodb" class="sidebar-link">使用Node链接MongoDB</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#express-中间件" class="sidebar-link">Express 中间件</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#get传参" class="sidebar-link">GET传参</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#restful-api" class="sidebar-link">Restful API</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#接口文档" class="sidebar-link">接口文档</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#接口说明" class="sidebar-link">接口说明</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#用户注册" class="sidebar-link">用户注册</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#路由模块" class="sidebar-link">路由模块</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#数据处理模块-mongoose" class="sidebar-link">数据处理模块(mongoose)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#使用" class="sidebar-link">使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#表单验证" class="sidebar-link">表单验证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#安装-2" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#使用-2" class="sidebar-link">使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#用户注册-2" class="sidebar-link">用户注册</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#jwt-认证" class="sidebar-link">JWT 认证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#安装-3" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#使用-3" class="sidebar-link">使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#用户登陆" class="sidebar-link">用户登陆</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#路由权限认证" class="sidebar-link">路由权限认证</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#用户修改" class="sidebar-link">用户修改</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#文件上传与管理" class="sidebar-link">文件上传与管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#文件上传" class="sidebar-link">文件上传</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#腾讯云视频点播服务-vod" class="sidebar-link">腾讯云视频点播服务(VoD)</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#视频列表及分页展示" class="sidebar-link">视频列表及分页展示</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#获取视频详情" class="sidebar-link">获取视频详情</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#频道订阅与取消订阅" class="sidebar-link">频道订阅与取消订阅</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#获取频道信息" class="sidebar-link">获取频道信息</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#搜索某用户-关注过谁" class="sidebar-link">搜索某用户 关注过谁</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#查看谁关注过我-我的粉丝列表" class="sidebar-link">查看谁关注过我（我的粉丝列表）</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#视频评论" class="sidebar-link">视频评论</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#删除视频评论" class="sidebar-link">删除视频评论</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#视频评论列表" class="sidebar-link">视频评论列表</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#视频是否喜欢" class="sidebar-link">视频是否喜欢</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#vim-命令" class="sidebar-link">vim 命令</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis-缓存" class="sidebar-link">Redis 缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#命令-2" class="sidebar-link">命令</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#地址" class="sidebar-link">地址</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis-cli-客户端链接" class="sidebar-link">redis-cli 客户端链接</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis-数据库" class="sidebar-link">redis 数据库</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis-数据类型" class="sidebar-link">redis 数据类型</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis-键名" class="sidebar-link">redis 键名</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#哈希操作指令" class="sidebar-link">哈希操作指令</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis列表" class="sidebar-link">Redis列表</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis-集合" class="sidebar-link">Redis 集合</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis-有序集合" class="sidebar-link">Redis 有序集合</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis-密码" class="sidebar-link">Redis 密码</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#redis-config-配置" class="sidebar-link">Redis config 配置</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#使用node操作redis" class="sidebar-link">使用Node操作Redis</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#热度排名案例" class="sidebar-link">热度排名案例</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#相关地址" class="sidebar-link">相关地址</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#视频收藏功能实现" class="sidebar-link">视频收藏功能实现</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#实现视频热门推荐机制" class="sidebar-link">实现视频热门推荐机制</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#unbantu" class="sidebar-link">unbantu</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#安装node" class="sidebar-link">安装node</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#nginx-反向代理与负载均衡" class="sidebar-link">nginx 反向代理与负载均衡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#nginx-安装与基本使用" class="sidebar-link">nginx 安装与基本使用</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#nginx-工作模型" class="sidebar-link">nginx 工作模型</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#nginx-命令" class="sidebar-link">nginx 命令</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#nginx-配置文件" class="sidebar-link">nginx 配置文件</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#nginx-反向代理" class="sidebar-link">nginx 反向代理</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#https-配置" class="sidebar-link">https 配置</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#项目完整地址" class="sidebar-link">项目完整地址</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#自定义脚手架的实现" class="sidebar-link">自定义脚手架的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#创建自定义全局指令" class="sidebar-link">创建自定义全局指令</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#使用commander处理help选项及自定义" class="sidebar-link">使用commander处理help选项及自定义</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#命令行问答交互-inquirer-js" class="sidebar-link">命令行问答交互(inquirer.js)</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#下载远程仓库模版代码-download-git-repo" class="sidebar-link">下载远程仓库模版代码(download-git-repo)</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#下载等待提示交互-ora" class="sidebar-link">下载等待提示交互(ora)</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#命令行样式渲染工具-chalk" class="sidebar-link">命令行样式渲染工具(chalk)</a></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#项目地址" class="sidebar-link">项目地址</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/views/nodejs/nodejs从0到1.html#将自己的脚手架工具发布到npm" class="sidebar-link">将自己的脚手架工具发布到npm</a></li></ul></li><li><a href="/blog/views/nodejs/buffer.html" class="sidebar-link">Buffer</a></li><li><a href="/blog/views/nodejs/mongoDB.html" class="sidebar-link">mongoDB在node中的使用</a></li><li><a href="/blog/views/nodejs/mongoDB配置.html" class="sidebar-link">mongoDB配置</a></li><li><a href="/blog/views/nodejs/nodejsExcel导出.html" class="sidebar-link">nodejs excel导出</a></li><li><a href="/blog/views/nodejs/nodemailer.html" class="sidebar-link">nodemailer+(node-schedule)+phantom 实现定时发送邮件截图</a></li><li><a href="/blog/views/nodejs/_path.html" class="sidebar-link">path</a></li><li><a href="/blog/views/nodejs/socket.io.html" class="sidebar-link">socket.io</a></li><li><a href="/blog/views/nodejs/爬虫.html" class="sidebar-link">爬虫</a></li><li><a href="/blog/views/nodejs/httpcode.html" class="sidebar-link">http 常见状态码</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>live</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpackOrCli</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>wechat</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端面试</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-73c95a87 data-v-584a622c><h3 class="title" style="display:none;" data-v-73c95a87 data-v-73c95a87>nodejs 从 0 到 1</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-73c95a87 data-v-73c95a87><input type="password" value="" data-v-73c95a87> <span data-v-73c95a87>Konck! Knock!</span> <button data-v-73c95a87>OK</button></label> <div class="footer" style="display:none;" data-v-73c95a87 data-v-73c95a87><span data-v-73c95a87><i class="iconfont reco-theme" data-v-73c95a87></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-73c95a87>vuePress-theme-reco</a></span> <span data-v-73c95a87><i class="iconfont reco-copyright" data-v-73c95a87></i> <a data-v-73c95a87><span data-v-73c95a87>zn</span>
            
          <span data-v-73c95a87>2018 - </span>
          2022
        </a></span></div></div> <div data-v-584a622c><main class="page"><!----> <div class="page-title" style="display:none;"><h1>nodejs 从 0 到 1</h1> <hr> <div data-v-7b2e794a><i class="iconfont reco-account" data-v-7b2e794a><span data-v-7b2e794a>zn</span></i> <i class="iconfont reco-date" data-v-7b2e794a><span data-v-7b2e794a>2022-10-14 12:10:00</span></i> <i class="iconfont reco-eye" data-v-7b2e794a><span id="/blog/views/nodejs/nodejs%E4%BB%8E0%E5%88%B01.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-7b2e794a><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-7b2e794a><span class="tag-item" data-v-7b2e794a>
      nodejs
    </span><span class="tag-item" data-v-7b2e794a>
      express
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div id="boxx" data-v-1e44702b><div data-v-1e44702b><p v-if="true" class="custom-block-title" data-v-1e44702b></p> <p v-if="true" data-v-1e44702b></p></div></div> <p></p><div class="table-of-contents"><ul><li><a href="#nodejs-到底是什么">nodejs 到底是什么</a></li><li><a href="#要实现什么-系统架构图">要实现什么 - 系统架构图</a></li><li><a href="#项目目录">项目目录</a></li><li><a href="#nodejs创建服务器">nodejs创建服务器</a><ul><li><a href="#服务器创建">服务器创建</a></li><li><a href="#获取get请求参数">获取GET请求参数</a></li><li><a href="#获取post请求及参数">获取POST请求及参数</a></li><li><a href="#处理不同的请求方式">处理不同的请求方式</a></li><li><a href="#处理不同数据类型">处理不同数据类型</a></li></ul></li><li><a href="#express">express</a><ul><li><a href="#express-适合做什么">express 适合做什么</a></li><li><a href="#创建服务器">创建服务器</a></li><li><a href="#创建请求方式-以对数据增、改、查为例">创建请求方式(以对数据增、改、查为例)</a></li></ul></li><li><a href="#数据持久化存储mongodb">数据持久化存储MongoDB</a><ul><li><a href="#mongodb-是什么">MongoDB 是什么</a></li><li><a href="#mongodb-有哪些特性">MongoDB 有哪些特性</a></li><li><a href="#mongodb-使用场景">MongoDB 使用场景</a></li><li><a href="#安装mongodb">安装MongoDB</a></li><li><a href="#命令">命令</a></li><li><a href="#mongdb基本增删改查操作">MongDB基本增删改查操作</a></li><li><a href="#使用node链接mongodb">使用Node链接MongoDB</a></li><li><a href="#express-中间件">Express 中间件</a></li><li><a href="#get传参">GET传参</a></li><li><a href="#restful-api">Restful API</a></li></ul></li><li><a href="#接口文档">接口文档</a><ul><li><a href="#接口说明">接口说明</a></li><li><a href="#用户注册">用户注册</a></li></ul></li><li><a href="#路由模块">路由模块</a></li><li><a href="#数据处理模块-mongoose">数据处理模块(mongoose)</a><ul><li><a href="#安装">安装</a></li><li><a href="#使用">使用</a></li></ul></li><li><a href="#表单验证">表单验证</a><ul><li><a href="#安装">安装</a></li><li><a href="#使用">使用</a></li></ul></li><li><a href="#用户注册">用户注册</a></li><li><a href="#jwt-认证">JWT 认证</a><ul><li><a href="#安装">安装</a></li><li><a href="#使用">使用</a></li></ul></li><li><a href="#用户登陆">用户登陆</a></li><li><a href="#路由权限认证">路由权限认证</a></li><li><a href="#用户修改">用户修改</a></li><li><a href="#文件上传与管理">文件上传与管理</a><ul><li><a href="#文件上传">文件上传</a></li><li><a href="#腾讯云视频点播服务-vod">腾讯云视频点播服务(VoD)</a></li></ul></li><li><a href="#视频列表及分页展示">视频列表及分页展示</a></li><li><a href="#获取视频详情">获取视频详情</a></li><li><a href="#频道订阅与取消订阅">频道订阅与取消订阅</a></li><li><a href="#获取频道信息">获取频道信息</a></li><li><a href="#搜索某用户-关注过谁">搜索某用户 关注过谁</a></li><li><a href="#查看谁关注过我-我的粉丝列表">查看谁关注过我（我的粉丝列表）</a></li><li><a href="#视频评论">视频评论</a></li><li><a href="#删除视频评论">删除视频评论</a></li><li><a href="#视频评论列表">视频评论列表</a></li><li><a href="#视频是否喜欢">视频是否喜欢</a></li><li><a href="#vim-命令">vim 命令</a></li><li><a href="#redis-缓存">Redis 缓存</a><ul><li><a href="#命令">命令</a></li><li><a href="#地址">地址</a></li><li><a href="#redis-cli-客户端链接">redis-cli 客户端链接</a></li><li><a href="#redis-数据库">redis 数据库</a></li><li><a href="#redis-数据类型">redis 数据类型</a></li><li><a href="#redis-键名">redis 键名</a></li><li><a href="#哈希操作指令">哈希操作指令</a></li><li><a href="#redis列表">Redis列表</a></li><li><a href="#redis-集合">Redis 集合</a></li><li><a href="#redis-有序集合">Redis 有序集合</a></li><li><a href="#redis-密码">Redis 密码</a></li><li><a href="#redis-config-配置">Redis config 配置</a></li><li><a href="#使用node操作redis">使用Node操作Redis</a></li><li><a href="#热度排名案例">热度排名案例</a></li><li><a href="#相关地址">相关地址</a></li></ul></li><li><a href="#视频收藏功能实现">视频收藏功能实现</a></li><li><a href="#实现视频热门推荐机制">实现视频热门推荐机制</a></li><li><a href="#unbantu">unbantu</a><ul><li><a href="#安装node">安装node</a></li></ul></li><li><a href="#nginx-反向代理与负载均衡">nginx 反向代理与负载均衡</a><ul><li><a href="#nginx-安装与基本使用">nginx 安装与基本使用</a></li><li><a href="#nginx-工作模型">nginx 工作模型</a></li><li><a href="#nginx-命令">nginx 命令</a></li><li><a href="#nginx-配置文件">nginx 配置文件</a></li><li><a href="#nginx-反向代理">nginx 反向代理</a></li></ul></li><li><a href="#https-配置">https 配置</a></li><li><a href="#项目完整地址">项目完整地址</a></li><li><a href="#自定义脚手架的实现">自定义脚手架的实现</a><ul><li><a href="#创建自定义全局指令">创建自定义全局指令</a></li><li><a href="#使用commander处理help选项及自定义">使用commander处理help选项及自定义</a></li><li><a href="#命令行问答交互-inquirer-js">命令行问答交互(inquirer.js)</a></li><li><a href="#下载远程仓库模版代码-download-git-repo">下载远程仓库模版代码(download-git-repo)</a></li><li><a href="#下载等待提示交互-ora">下载等待提示交互(ora)</a></li><li><a href="#命令行样式渲染工具-chalk">命令行样式渲染工具(chalk)</a></li><li><a href="#项目地址">项目地址</a></li></ul></li><li><a href="#将自己的脚手架工具发布到npm">将自己的脚手架工具发布到npm</a></li></ul></div><p></p> <h2 id="nodejs-到底是什么"><a href="#nodejs-到底是什么" class="header-anchor">#</a> nodejs 到底是什么</h2> <ul><li>nodejs不是一种独立的编程语言，也不是javascript框架</li> <li>nodejs是一个基于chrome v8 引擎的javascript运行环境</li></ul> <h2 id="要实现什么-系统架构图"><a href="#要实现什么-系统架构图" class="header-anchor">#</a> 要实现什么 - 系统架构图</h2> <figure class="third"><img src="/blog/img/node/sys_server.png" width="600px"></figure> <h2 id="项目目录"><a href="#项目目录" class="header-anchor">#</a> 项目目录</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">.</span>
├── app<span class="token punctuation">.</span>js                      <span class="token comment">// 入口文件</span>
├── config                      <span class="token comment">// 配置项</span>
│   └── config<span class="token punctuation">.</span>default<span class="token punctuation">.</span>js
├── controller                  <span class="token comment">// 业务逻辑</span>
│   ├── index<span class="token punctuation">.</span>js
│   ├── userController<span class="token punctuation">.</span>js
│   ├── videoController<span class="token punctuation">.</span>js
│   └── vodController<span class="token punctuation">.</span>js
├── middleware                  <span class="token comment">// 中间件</span>
│   └── validator               <span class="token comment">//  表单验证 </span>
│       ├── errorBack<span class="token punctuation">.</span>js
│       ├── userValidator<span class="token punctuation">.</span>js
│       └── videoValidator<span class="token punctuation">.</span>js   
├── model                      <span class="token comment">// mongoos 模型</span>
│   ├── baseModel<span class="token punctuation">.</span>js           <span class="token comment">// 公共模型</span>
│   ├── collectionModel<span class="token punctuation">.</span>js     <span class="token comment">// 收藏</span>
│   ├── commentModel<span class="token punctuation">.</span>js        <span class="token comment">// 评论</span>
│   ├── index<span class="token punctuation">.</span>js               <span class="token comment">// mongoos 配置</span>
│   ├── redis                   <span class="token comment">// redis 配置</span>
│   │   ├── index<span class="token punctuation">.</span>js
│   │   └── redisVideoHots<span class="token punctuation">.</span>js   <span class="token comment">// redis 实现热门推荐</span>
│   ├── subscribeModel<span class="token punctuation">.</span>js       <span class="token comment">// 订阅模型</span>
│   ├── userModel<span class="token punctuation">.</span>js            <span class="token comment">// 用户</span>
│   ├── videoModel<span class="token punctuation">.</span>js           <span class="token comment">// 视频</span>
│   └── videolikeModel<span class="token punctuation">.</span>js       <span class="token comment">// 视频是否喜欢</span>
├── router                      <span class="token comment">// express 路由</span>
│   ├── index<span class="token punctuation">.</span>js                <span class="token comment">// 路由配置文件</span>
│   ├── user<span class="token punctuation">.</span>js                 <span class="token comment">// 用户相关路由</span>
│   └── video<span class="token punctuation">.</span>js                <span class="token comment">// 视频相关路由</span>
└── utils                       
    ├── jwt<span class="token punctuation">.</span>js                  <span class="token comment">// jwt 验证</span>
    └── md5<span class="token punctuation">.</span>js                  <span class="token comment">// md5 加密</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="nodejs创建服务器"><a href="#nodejs创建服务器" class="header-anchor">#</a> nodejs创建服务器</h2> <h3 id="服务器创建"><a href="#服务器创建" class="header-anchor">#</a> 服务器创建</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
   <span class="token comment">//1. 获取服务器对象</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 2. 监听端口</span>
   server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8080'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1:8080'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token operator">...</span>
       res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'HelloWorld'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="获取get请求参数"><a href="#获取get请求参数" class="header-anchor">#</a> 获取GET请求参数</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// user?id=123&amp;name=dave</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> params <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
params<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="获取post请求及参数"><a href="#获取post请求及参数" class="header-anchor">#</a> 获取POST请求及参数</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>
 <span class="token comment">// post数据是不断的叠加，不是一次性全部请求到的</span>
 server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token comment">//接收数据</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       data <span class="token operator">+=</span> d
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 数据接收完成</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="处理不同的请求方式"><a href="#处理不同的请求方式" class="header-anchor">#</a> 处理不同的请求方式</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>   server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token operator">...</span>
       res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token operator">...</span>
       res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="处理不同数据类型"><a href="#处理不同数据类型" class="header-anchor">#</a> 处理不同数据类型</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/user'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="express"><a href="#express" class="header-anchor">#</a> express</h2> <h3 id="express-适合做什么"><a href="#express-适合做什么" class="header-anchor">#</a> express 适合做什么</h3> <ul><li>传统Web网站</li> <li>API 接口服务器</li> <li>服务端渲染中间层</li> <li>自定义集成框架</li> <li>开发辅助工具(webpack-dev-server...)</li></ul> <h3 id="创建服务器"><a href="#创建服务器" class="header-anchor">#</a> 创建服务器</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8081'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'liste http:127.0.0.1:8080'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="创建请求方式-以对数据增、改、查为例"><a href="#创建请求方式-以对数据增、改、查为例" class="header-anchor">#</a> 创建请求方式(以对数据增、改、查为例)</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token comment">//data.json </span>
 <span class="token comment">// {&quot;users&quot;:[{&quot;id&quot;:1,&quot;username&quot;:&quot;dave&quot;,&quot;age&quot;:17}]}</span>
 
 <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
 <span class="token keyword">const</span> <span class="token punctuation">{</span>promisify<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>
  <span class="token comment">// 接收表单数据</span>
 app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token comment">// 接收json数据</span>
 app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token comment">// 把回调函数变为promise</span>
 <span class="token keyword">const</span> readFile <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span>
 <span class="token keyword">const</span> writeFile <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>writeFile<span class="token punctuation">)</span>
 app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./data.json'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
   res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
 
 <span class="token comment">// 增加</span>
 app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./data.json'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> jsonObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token keyword">const</span> users <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>users
  <span class="token keyword">const</span> id <span class="token operator">=</span> users<span class="token punctuation">[</span>users<span class="token punctuation">.</span>length <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token keyword">const</span> addusers <span class="token operator">=</span> <span class="token punctuation">{</span>id<span class="token punctuation">,</span> <span class="token operator">...</span>req<span class="token punctuation">.</span>body<span class="token punctuation">}</span>
  jsonObj<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>addusers<span class="token punctuation">)</span>
 <span class="token comment">// 写入数据</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
   <span class="token keyword">await</span> <span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'./data.json'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">)</span><span class="token punctuation">)</span>
   res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">)</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'写入错误'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
 
 <span class="token comment">//修改</span>
 app<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id
    <span class="token keyword">const</span> body <span class="token operator">=</span> req<span class="token punctuation">.</span>body
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
     <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./data.json'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
     <span class="token keyword">const</span> jsonObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
     <span class="token keyword">const</span> user <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">ret</span> <span class="token operator">=&gt;</span> ret<span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span><span class="token punctuation">{</span>
       res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>message<span class="token operator">:</span> <span class="token string">'用户不存在'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
     user<span class="token punctuation">.</span>username <span class="token operator">=</span> body<span class="token punctuation">.</span>username<span class="token operator">?</span>body<span class="token punctuation">.</span>username <span class="token operator">:</span> user<span class="token punctuation">.</span>username
     user<span class="token punctuation">.</span>age <span class="token operator">=</span> body<span class="token punctuation">.</span>age<span class="token operator">?</span>body<span class="token punctuation">.</span>age <span class="token operator">:</span> user<span class="token punctuation">.</span>age
     jsonObj<span class="token punctuation">.</span>users<span class="token punctuation">[</span>jsonObj<span class="token punctuation">.</span>users<span class="token punctuation">.</span>id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> user

     <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token keyword">await</span> <span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'./data.json'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">)</span><span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">)</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>

   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h2 id="数据持久化存储mongodb"><a href="#数据持久化存储mongodb" class="header-anchor">#</a> 数据持久化存储MongoDB</h2> <h3 id="mongodb-是什么"><a href="#mongodb-是什么" class="header-anchor">#</a> MongoDB 是什么</h3> <ul><li>一个基于文件存储的分布式 NoSQL(非关系型数据库) 数据库系统(所有的数据都是以文件的形式存储在磁盘)</li> <li>数据结构由键值对(key,value)组成</li> <li>拥有非常强大的查询能力</li></ul> <h3 id="mongodb-有哪些特性"><a href="#mongodb-有哪些特性" class="header-anchor">#</a> MongoDB 有哪些特性</h3> <ul><li>文档型数据库，较强可扩展性，拥有强大的查询语言，多种存储引擎</li> <li>高性能，高可用，水平扩展：支持数据嵌入，子文档查询、支持副本集与分片</li> <li>多种查询类型支持，且支持数据聚合查询、文本检索、地址位置查询</li></ul> <h3 id="mongodb-使用场景"><a href="#mongodb-使用场景" class="header-anchor">#</a> MongoDB 使用场景</h3> <ul><li>对数据处理性能有较高要求</li> <li>需要借助缓存层来处理数据</li> <li>需要高度的伸缩性</li></ul> <h3 id="安装mongodb"><a href="#安装mongodb" class="header-anchor">#</a> 安装MongoDB</h3> <ol><li>奇数版本为测试版，偶数为稳定版</li> <li>3.2之后。不再支持32位操作系统</li> <li>https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-os-x/</li></ol> <h3 id="命令"><a href="#命令" class="header-anchor">#</a> 命令</h3> <ol><li>show dbs 查看当前数据库有哪些</li> <li>use xxx 切换到某个数据库</li> <li>db 查看当前在哪个数据库</li> <li>show collections 显示集合</li> <li>db.xx.drop() &lt;xx哪个集合&gt; 删除某个集合</li> <li>exit 退出</li></ol> <h3 id="mongdb基本增删改查操作"><a href="#mongdb基本增删改查操作" class="header-anchor">#</a> MongDB基本增删改查操作</h3> <h4 id="增"><a href="#增" class="header-anchor">#</a> 增</h4> <ul><li>增加一条数据</li></ul> <div class="language-mongodb line-numbers-mode"><pre class="language-text"><code>    db.cc.insertOne({username: 'list', age: 12})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>增加多条数据</li></ul> <div class="language-mongodb line-numbers-mode"><pre class="language-text"><code> db.cc.insertMany([
    {username: 'list', age: 13},
    {username: 'list2', age: 15}
 ])
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="查"><a href="#查" class="header-anchor">#</a> 查</h4> <ul><li>查找</li></ul> <div class="language-mongodb line-numbers-mode"><pre class="language-text"><code>db.cc.find({username: 'list'})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>查找一条数据</li></ul> <div class="language-mongodb line-numbers-mode"><pre class="language-text"><code>db.cc.findOne({username: 'list'})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>按条件查找</li></ul> <div class="language-mongodb line-numbers-mode"><pre class="language-text"><code>    db.cc.find({age: {$gt: 15}})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h4> <ul><li>把username等于lisi的年龄更新为60</li></ul> <div class="language-mongodb line-numbers-mode"><pre class="language-text"><code>    db.cc.updateOne({username: 'lisi'}, {$set:{age:60}})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>把年龄大于1的username改为lisi</li></ul> <div class="language-mongodb line-numbers-mode"><pre class="language-text"><code>   db.cc.updateMany({age:{$gt: 1}}, {$set: {username: 'lisi'}})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="删除"><a href="#删除" class="header-anchor">#</a> 删除</h4> <ul><li>删除年龄等于60的数据</li></ul> <div class="language-mongodb line-numbers-mode"><pre class="language-text"><code>    db.cc.deleteOne({age: 60})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>删除年龄大于100的数据</li></ul> <div class="language-mongodb line-numbers-mode"><pre class="language-text"><code>   db.cc.deleteMany({age: {$gt:100}})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="使用node链接mongodb"><a href="#使用node链接mongodb" class="header-anchor">#</a> 使用Node链接MongoDB</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> MongoClient <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongodb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'mongodb://localhost:27017'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">clinetDB</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 库名</span>
    <span class="token keyword">const</span> dbName <span class="token operator">=</span> <span class="token string">'mytest'</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Connected successfully to server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> db <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">db</span><span class="token punctuation">(</span>dbName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 集合</span>
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> collection <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">clinetDB</span><span class="token punctuation">(</span><span class="token string">'cc'</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 查找cc集合下的所有</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> d<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 插入一条数据</span>
    <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token operator">:</span> <span class="token string">'dave'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 多条插入</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
          <span class="token punctuation">{</span>username<span class="token operator">:</span> <span class="token string">'dave1'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>username<span class="token operator">:</span> <span class="token string">'dave2'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">}</span>
     <span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 查找username为dave的数据</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token operator">:</span> <span class="token string">'dave'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> d<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 更新username为dave的数据，把年龄改为10岁</span>
    <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token operator">:</span> <span class="token string">'dave'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>$set<span class="token operator">:</span> <span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 更新 把年龄大于12岁的username改为wangwu</span>
    <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">updateMany</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token punctuation">{</span>$gt<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>$set<span class="token operator">:</span> <span class="token punctuation">{</span>username<span class="token operator">:</span> <span class="token string">'wangwu'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   
   <span class="token comment">// 删除年龄大于10岁的第一条数据</span>
    <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">deleteOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token punctuation">{</span>$gt<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 删除年龄大于10岁的所有数据</span>
    <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">deleteMany</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token punctuation">{</span>$gt<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><ul><li>文档地址 https://www.mongodb.com/docs/drivers/node/current</li></ul> <h3 id="express-中间件"><a href="#express-中间件" class="header-anchor">#</a> Express 中间件</h3> <h4 id="错误处理中间件"><a href="#错误处理中间件" class="header-anchor">#</a> 错误处理中间件</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 当有4个参数时，express 会把它作为处理错误使用</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'service Error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="内置中间件"><a href="#内置中间件" class="header-anchor">#</a> 内置中间件</h4> <ul><li>express.json()、express.urlencoded() 等</li></ul> <h4 id="第三方中间件"><a href="#第三方中间件" class="header-anchor">#</a> 第三方中间件</h4> <ul><li>cors、morgan(日志记录)</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 开发环境记录日志</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="get传参"><a href="#get传参" class="header-anchor">#</a> GET传参</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// http:localhost/user/1/video/2</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id/video/:vid'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id
    req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>vid
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// http:localhost?user=1&amp;video=2</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    req<span class="token punctuation">.</span>query
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="restful-api"><a href="#restful-api" class="header-anchor">#</a> Restful API</h3> <ul><li>https://restfulapi.cn</li></ul> <h2 id="接口文档"><a href="#接口文档" class="header-anchor">#</a> 接口文档</h2> <h3 id="接口说明"><a href="#接口说明" class="header-anchor">#</a> 接口说明</h3> <ul><li>基于RESTful API 接口规范</li> <li>基于JWT 身份认证</li> <li>使用cors 跨域</li> <li>接口基础请求地址：http:// 127.0.0.1:3000/api/v1</li> <li>使用JSON 格式进行数据通信</li></ul> <h3 id="用户注册"><a href="#用户注册" class="header-anchor">#</a> 用户注册</h3> <p>path: /user/registers
methods:post
是否认证: false</p> <table><thead><tr><th>字段名</th> <th>字段类型</th> <th>是否必须</th></tr></thead> <tbody><tr><td>username</td> <td>string</td> <td>true</td></tr> <tr><td>email</td> <td>string</td> <td>true</td></tr> <tr><td>phone</td> <td>string</td> <td>true</td></tr> <tr><td>password</td> <td>string</td> <td>true</td></tr></tbody></table> <p>请求示例:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dave&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">17</span><span class="token punctuation">,</span>
    <span class="token string">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123@qq.com&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;phone&quot;</span><span class="token operator">:</span> <span class="token string">&quot;13312345678&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123456&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>响应示例:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// success</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dave&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token string">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1232@qq.com&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;phone&quot;</span><span class="token operator">:</span> <span class="token number">13312345648</span><span class="token punctuation">,</span>
    <span class="token string">&quot;createAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-09-23T09:03:45.232Z&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;updateAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-09-23T09:03:45.232Z&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;632d76ace3388d81e4f92ef0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;__v&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
<span class="token comment">//error</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;errors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;年龄不能为空&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;param&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;location&quot;</span><span class="token operator">:</span> <span class="token string">&quot;body&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="路由模块"><a href="#路由模块" class="header-anchor">#</a> 路由模块</h2> <blockquote><p>路由和业务代码分离 controller 目录存放路由的业务代码， router存放路由</p></blockquote> <p>根目录下创建 controller 目录</p> <ul><li>controller / userController.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>根目录下创建 router 目录</p> <ul><li>user.js 用户相关的理由</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/userController'</span><span class="token punctuation">)</span> 

router
<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>login<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>list<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>delete<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>register<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>index.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router
<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./user'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>app.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/v1'</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="数据处理模块-mongoose"><a href="#数据处理模块-mongoose" class="header-anchor">#</a> 数据处理模块(mongoose)</h2> <blockquote><p>文档地址 https://mongoosejs.com</p></blockquote> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    npm install mongoose
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h3> <p>根目录下新建 model 文件夹</p> <ul><li><code>model / baseModel.js</code> 存放共有的 model(模型)</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    createAt<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Date<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    updateAt<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Date<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><code>model / userModel.js</code> 存放用户相关的 model 模型</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> baseModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./baseModel'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> md5 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/md5'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        username<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> String<span class="token punctuation">,</span>
            required<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> String<span class="token punctuation">,</span>
            required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token comment">// 密码 md5 加密</span>
            <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token function">md5</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 查询时，不返回密码</span>
            select<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        age<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> Number<span class="token punctuation">,</span>
            required<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        email<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> String<span class="token punctuation">,</span>
            required<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        phone<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> Number<span class="token punctuation">,</span>
            required<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>baseModel
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> userSchema
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ul><li><code>model / index.js</code> 连接 mongoose 并导入 user 模型</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 如果没有video则自动创建</span>
   <span class="token keyword">await</span> mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/video'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mongodb 已连接'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// mongodb会把U变为小写,结尾加s users</span>
    <span class="token comment">// 如果User不存在，则自动创建</span>
    User<span class="token operator">:</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./userModel'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="表单验证"><a href="#表单验证" class="header-anchor">#</a> 表单验证</h2> <blockquote><p>文档地址 https://express-validator.github.io/docs/running-imperatively.html</p></blockquote> <h3 id="安装-2"><a href="#安装-2" class="header-anchor">#</a> 安装</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    npm install express<span class="token operator">-</span>validator
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="使用-2"><a href="#使用-2" class="header-anchor">#</a> 使用</h3> <p>在根目录下新建validator目录 /middleware/validator</p> <ul><li>userValidator.js 用户表单校验</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token keyword">const</span> <span class="token punctuation">{</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-validator'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> validator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./errorBack'</span><span class="token punctuation">)</span>
    
    module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>register <span class="token operator">=</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment">// bail 上一个验证通过后在执行下一个验证</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">'用户名不能为空'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span>min<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">'用户名长度不能小于3个字符并且不能大于10个字符'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">'年龄不能为空'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// custom 自定义验证</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">'邮箱不能为空'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">'邮箱格式有误'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'val'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
          <span class="token keyword">const</span> emailValidate <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> val<span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>emailValidate<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'邮箱已注册'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'phone'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">'手机号不能为空'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">isMobilePhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">'手机号格式有误'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> phoneValidate <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>phone<span class="token operator">:</span> val<span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>phoneValidate<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'手机号已注册'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ul><li>errorBack.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> validationResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-validator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">validations</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment">// 循环验证每项</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>validations<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">validation</span> <span class="token operator">=&gt;</span> validation<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> errors<span class="token operator">:</span>errors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>给路由添加校验 router/user.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> userValidator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../middleware/validator/userValidator'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/userController'</span><span class="token punctuation">)</span> 

<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> userValidator<span class="token punctuation">.</span>register <span class="token punctuation">,</span> controller<span class="token punctuation">.</span>register<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="用户注册-2"><a href="#用户注册-2" class="header-anchor">#</a> 用户注册</h2> <ul><li>controller/userController.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/index'</span><span class="token punctuation">)</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> userdb <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
   <span class="token keyword">const</span> dbBack <span class="token operator">=</span> <span class="token keyword">await</span> userdb<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">const</span> user <span class="token operator">=</span> dbBack<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">delete</span> user<span class="token punctuation">.</span>password
   res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// router/user.js</span>
<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> userValidator<span class="token punctuation">.</span>register <span class="token punctuation">,</span> controller<span class="token punctuation">.</span>register<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="jwt-认证"><a href="#jwt-认证" class="header-anchor">#</a> JWT 认证</h2> <blockquote><p>介绍 https://restfulapi.cn/page/jwt
文档地址 https://github.com/auth0/node-jsonwebtoken</p></blockquote> <h3 id="安装-3"><a href="#安装-3" class="header-anchor">#</a> 安装</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    npm i jsonwebtoken
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="使用-3"><a href="#使用-3" class="header-anchor">#</a> 使用</h3> <ul><li>在 utils 目录下新建 jwt.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 回调变promise</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>promisify<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 随机签名</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> uuid <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config/config.default'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sign <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>sign<span class="token punctuation">)</span>
<span class="token keyword">const</span> verify <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>verify<span class="token punctuation">)</span>

<span class="token comment">// 创建token</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">createJwtToken</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">userinfo</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>userinfo<span class="token punctuation">}</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> token
<span class="token punctuation">}</span>

<span class="token comment">// 校验token</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">verifyToken</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> bearerToken <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>authorization
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bearerToken<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">402</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">&quot;token不存在&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> bearerToken<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'Bearer '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> uuid<span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token string">'402'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'无效token'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="用户登陆"><a href="#用户登陆" class="header-anchor">#</a> 用户登陆</h2> <ul><li><code>controller/userController.js</code></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>createJwtToken<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/jwt'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/index'</span><span class="token punctuation">)</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> dbUser <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dbUser<span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'error'</span><span class="token operator">:</span> <span class="token string">'用户名或密码错误'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 创建token</span>
   <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createJwtToken</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
   <span class="token keyword">const</span> user <span class="token operator">=</span> dbUser<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   user<span class="token punctuation">.</span>token <span class="token operator">=</span> token
   res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="路由权限认证"><a href="#路由权限认证" class="header-anchor">#</a> 路由权限认证</h2> <ul><li>router/user.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>verifyToken<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/jwt'</span><span class="token punctuation">)</span>
<span class="token comment">// verifyToken 作为中间件传人</span>
router
<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> verifyToken<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>list<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="用户修改"><a href="#用户修改" class="header-anchor">#</a> 用户修改</h2> <blockquote><p>用户名、手机号、邮箱 是唯一的，不能修改为已经存在的</p></blockquote> <ul><li>middleware / validator / userValidator.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>update <span class="token operator">=</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span>min<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">'用户名长度不能小于3个字符并且不能大于10个字符'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> userValida <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token operator">:</span> val<span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token comment">// 不可以改为已经存在的用户名</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>userValida<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'用户名已注册'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">'邮箱格式有误'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> emailVallida <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> val<span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>emailVallida<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'邮箱已注册'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'phone'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> phoneVallida <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>phone<span class="token operator">:</span> val<span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>phoneVallida<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'手机号已注册'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ul><li>controller/userController.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userid <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id
    <span class="token comment">// 更新id为xxx的数据   new:true 返回更新后的数据，默认返回更新前的数据</span>
    <span class="token keyword">const</span> updatedb <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>updatedb<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>router / user.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>router
<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/update'</span><span class="token punctuation">,</span> userValidator<span class="token punctuation">.</span>update<span class="token punctuation">,</span> verifyToken<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>update<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="文件上传与管理"><a href="#文件上传与管理" class="header-anchor">#</a> 文件上传与管理</h2> <h3 id="文件上传"><a href="#文件上传" class="header-anchor">#</a> 文件上传</h3> <h4 id="安装-4"><a href="#安装-4" class="header-anchor">#</a> 安装</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// https://www.npmjs.com/package/multer</span>
    npm i multer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="图片上传"><a href="#图片上传" class="header-anchor">#</a> 图片上传</h4> <ul><li>router / user.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/userController'</span><span class="token punctuation">)</span> 
<span class="token keyword">const</span> <span class="token punctuation">{</span>verifyToken<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/jwt'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> multer  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span>
<span class="token comment">// dest 上传到哪</span>
<span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dest<span class="token operator">:</span> <span class="token string">'public/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

router
<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/uploadimg'</span><span class="token punctuation">,</span> verifyToken<span class="token punctuation">,</span> 
<span class="token comment">// uploadimg 与客户端约定的name</span>
<span class="token comment">// upload.single 作为中间件 会把上传后的信息传到controller.uploadimg，通过 req.file 接收</span>

upload<span class="token punctuation">.</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token string">'uploadimg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    controller<span class="token punctuation">.</span>uploadimg<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>controller / userController.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>promisify<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> rename <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>rename<span class="token punctuation">)</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">uploadimg</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> filename <span class="token operator">=</span> req<span class="token punctuation">.</span>file<span class="token punctuation">.</span>filename
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">const</span> originalname <span class="token operator">=</span> req<span class="token punctuation">.</span>file<span class="token punctuation">.</span>originalname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> fix <span class="token operator">=</span> originalname<span class="token punctuation">[</span>originalname<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">// 上传到的文件没有后缀，需要重命名</span>
    <span class="token keyword">await</span> <span class="token function">rename</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> path <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> fix<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>url<span class="token operator">:</span> filename <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> fix<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="腾讯云视频点播服务-vod"><a href="#腾讯云视频点播服务-vod" class="header-anchor">#</a> 腾讯云视频点播服务(VoD)</h3> <blockquote><p>视频转码、防盗链等功能</p></blockquote> <ol><li>前端发起请求到自己的服务器，</li> <li>服务器再去请求阿里云获取上传凭证给客户端做返回，</li> <li>客户端根据凭证上传视频</li> <li>客户端上传成功后把阿里云提供的视频id，入库到我们自己的数据库</li></ol> <h4 id="获取vod上传凭证及地址"><a href="#获取vod上传凭证及地址" class="header-anchor">#</a> 获取VoD上传凭证及地址</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 服务端</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">vod</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;querystring&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 确定 app 的云 API 密钥</span>
    <span class="token keyword">var</span> secret_id <span class="token operator">=</span> <span class="token string">&quot;AKIDd9SXP4UVJuHRP9h06yd3SffQzMahgdVF&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> secret_key <span class="token operator">=</span> <span class="token string">&quot;d6RhKF4mLl2BATdgaN2Y3PbfeVHwTr5A&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 确定签名的当前时间和失效时间</span>
    <span class="token keyword">var</span> current <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> expired <span class="token operator">=</span> current <span class="token operator">+</span> <span class="token number">86400</span><span class="token punctuation">;</span>  <span class="token comment">// 签名有效期：1天</span>
    <span class="token comment">// 向参数列表填入参数</span>
    <span class="token keyword">var</span> arg_list <span class="token operator">=</span> <span class="token punctuation">{</span>
    secretId <span class="token operator">:</span> secret_id<span class="token punctuation">,</span>
    currentTimeStamp <span class="token operator">:</span> current<span class="token punctuation">,</span>
    expireTime <span class="token operator">:</span> expired<span class="token punctuation">,</span>
    random <span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 计算签名</span>
    <span class="token keyword">const</span> orignal <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arg_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> orignal_buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>orignal<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> hmac <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">&quot;sha1&quot;</span><span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hmac_buffer <span class="token operator">=</span> hmac<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>orignal_buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> signature <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>hmac_buffer<span class="token punctuation">,</span> orignal_buffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>sign<span class="token operator">:</span> signature<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 客户端获取</span>
<span class="token keyword">function</span> <span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1:3000/api/v1/video/getvod'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sign<span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sign<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="vod服务-客户端上传"><a href="#vod服务-客户端上传" class="header-anchor">#</a> VOD服务-客户端上传</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;file&quot;</span> ref<span class="token operator">=</span><span class="token string">&quot;mediaFile&quot;</span> @change<span class="token operator">=</span><span class="token string">&quot;change&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
 
<span class="token keyword">const</span> tcVod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TcVod</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  getSignature<span class="token operator">:</span> getSignature <span class="token comment">// 前文中所述的获取上传签名的函数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> mediaFile <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">change</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> uploader <span class="token operator">=</span> tcVod<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mediaFile<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
uploader<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'media_progress'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>percent<span class="token punctuation">)</span> <span class="token comment">// 进度</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
uploader<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doneResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// deal with doneResult</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'doneResult'</span><span class="token punctuation">,</span>doneResult<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// deal with error</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="视频信息入库操作"><a href="#视频信息入库操作" class="header-anchor">#</a> 视频信息入库操作</h4> <ul><li>新建 model层 videoModel.js，主要把上传到腾讯云后返回的vodvideoId 和用户id传给后端</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> baseModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./baseModel'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> videoSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    description<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    vodvideoId<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 关联users 集合</span>
        ref<span class="token operator">:</span> <span class="token string">'User'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    cover<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    videoComment<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Number<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    likeCount<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Number<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    dislikeCount<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Number<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>baseModel
<span class="token punctuation">}</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> videoSchema
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><ul><li>创建视频</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">createVideo</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> userid <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id
    body<span class="token punctuation">.</span>user <span class="token operator">=</span> userid
    <span class="token keyword">const</span> dbvideo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Video</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    <span class="token keyword">const</span> dbback <span class="token operator">=</span> <span class="token keyword">await</span> dbvideo<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>dbback<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="视频列表及分页展示"><a href="#视频列表及分页展示" class="header-anchor">#</a> 视频列表及分页展示</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">videolist</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> dbdata <span class="token operator">=</span> <span class="token keyword">await</span> Video<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pageNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{</span>createAt<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
    
        <span class="token keyword">const</span> videoCount <span class="token operator">=</span> <span class="token keyword">await</span> Video<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>videolist<span class="token operator">:</span> dbdata<span class="token punctuation">,</span> videoCount<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="获取视频详情"><a href="#获取视频详情" class="header-anchor">#</a> 获取视频详情</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 客户端传过来的video_id查找</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">videoDetail</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>video_id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params
    <span class="token keyword">const</span> dbBack <span class="token operator">=</span> <span class="token keyword">await</span> Video<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>video_id<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'username cover image'</span><span class="token punctuation">)</span>
    <span class="token function">redisVideoHots</span><span class="token punctuation">(</span>video<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>dbBack<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="频道订阅与取消订阅"><a href="#频道订阅与取消订阅" class="header-anchor">#</a> 频道订阅与取消订阅</h2> <ol><li>用户不能关注自己</li> <li>需要拿到两个ID，当前登陆用户的ID和要关注的ID，如果当前用户ID和要关注的ID已经存在，说明已经关注否则执行入库操作</li> <li>A 关注 B，B相当于多一个粉丝，所以要给 B 粉丝加 1</li></ol> <ul><li>model层</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> baseModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./baseModel'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> subscribeSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        ref<span class="token operator">:</span> <span class="token string">'User'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    channel<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        ref<span class="token operator">:</span> <span class="token string">'User'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>baseModel
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> subscribeSchema
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>订阅（关注）</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">subscribe</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 自己不能关注自己 当前登陆的id 比较 传过来的id</span>
    <span class="token keyword">const</span> userid <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id
    <span class="token keyword">const</span> channel_id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>channel_id
    <span class="token keyword">if</span><span class="token punctuation">(</span>userid <span class="token operator">===</span> channel_id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'不能关注自己'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2. 判断 用户是否已经关注过此用户 channel_id </span>
    <span class="token keyword">const</span> subscribe <span class="token operator">=</span> <span class="token keyword">await</span> Subscribe<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        user<span class="token operator">:</span> userid<span class="token punctuation">,</span>
        channel<span class="token operator">:</span> channel_id
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'已经关注过了'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3. 未关注 存入数据库，并使被关注的粉丝加1</span>
    <span class="token keyword">const</span> insertdb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        user<span class="token operator">:</span> userid<span class="token punctuation">,</span>
        channel<span class="token operator">:</span> channel_id
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> insertResult <span class="token operator">=</span> <span class="token keyword">await</span> insertdb<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>channel_id<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        user<span class="token punctuation">.</span>subscribecount <span class="token operator">++</span>
        <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>message<span class="token operator">:</span> <span class="token string">'关注成功'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ul><li>取消订阅</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">unsubscribe</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userid <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id
    <span class="token keyword">const</span> channel_id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>channel_id
    <span class="token keyword">if</span><span class="token punctuation">(</span>userid <span class="token operator">===</span> channel_id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'不能取消关注自己'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> subscribe <span class="token operator">=</span> <span class="token keyword">await</span> Subscribe<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        user<span class="token operator">:</span> userid<span class="token punctuation">,</span>
        channel<span class="token operator">:</span> channel_id
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">await</span> subscribe<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>channel_id<span class="token punctuation">)</span>
       user<span class="token punctuation">.</span>subscribecount <span class="token operator">--</span>
       <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'message'</span><span class="token operator">:</span> <span class="token string">&quot;取消成功&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'还没关注过'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="获取频道信息"><a href="#获取频道信息" class="header-anchor">#</a> 获取频道信息</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// A 查询 B 的信息</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">getUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> isSubscribe <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token keyword">await</span> Subscribe<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            user<span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
            channel<span class="token operator">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>user_id
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        isSubscribe <span class="token operator">=</span> record <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
    <span class="token keyword">let</span> formatObj <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">,</span> <span class="token string">'cover'</span><span class="token punctuation">,</span> <span class="token string">'subscribecount'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>formatObj<span class="token punctuation">,</span>
        isSubscribe
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="搜索某用户-关注过谁"><a href="#搜索某用户-关注过谁" class="header-anchor">#</a> 搜索某用户 关注过谁</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">getSubscribe</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> subscribeList <span class="token operator">=</span> <span class="token keyword">await</span> Subscribe<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        user<span class="token operator">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>user_id
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'channel'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'subscribeList'</span><span class="token punctuation">,</span> subscribeList<span class="token punctuation">)</span>
    subscribeList <span class="token operator">=</span> subscribeList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> lodash<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>channel<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'cover'</span><span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">,</span> <span class="token string">'subscribecount'</span><span class="token punctuation">,</span> <span class="token string">'channeldes'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>subscribeList<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="查看谁关注过我-我的粉丝列表"><a href="#查看谁关注过我-我的粉丝列表" class="header-anchor">#</a> 查看谁关注过我（我的粉丝列表）</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">getChannel</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> channelList <span class="token operator">=</span> <span class="token keyword">await</span> Subscribe<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        channel<span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
    channelList <span class="token operator">=</span> channelList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> lodash<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'cover'</span><span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">,</span> <span class="token string">'subscribecount'</span><span class="token punctuation">,</span> <span class="token string">'channeldes'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>channelList<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="视频评论"><a href="#视频评论" class="header-anchor">#</a> 视频评论</h2> <ul><li>model层 commentModel.js 字段为谁对哪条视频的评论及评论内容</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> baseModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./baseModel'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> commentSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        ref<span class="token operator">:</span> <span class="token string">'User'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    video<span class="token operator">:</span> <span class="token punctuation">{</span>
       type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
       required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
       ref<span class="token operator">:</span> <span class="token string">'Video'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>baseModel
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> commentSchema
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li>评论</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">comment</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id
    <span class="token keyword">const</span> video <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>video_id
    <span class="token keyword">const</span> content <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>content
    <span class="token keyword">const</span> videodb <span class="token operator">=</span> <span class="token keyword">await</span> Video<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>videodb<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> dbback <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                user<span class="token punctuation">,</span>
                video<span class="token punctuation">,</span>
                content
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            videodb<span class="token punctuation">.</span>videoComment <span class="token operator">++</span>
            <span class="token keyword">await</span> videodb<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">redisVideoHots</span><span class="token punctuation">(</span>video<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>dbback<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>error<span class="token operator">:</span> <span class="token string">'视频不存在'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="删除视频评论"><a href="#删除视频评论" class="header-anchor">#</a> 删除视频评论</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">commentDelete</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> video_id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>video_id
    <span class="token keyword">const</span> comment_id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>comment_id
    <span class="token comment">// 视频是否存在</span>
    <span class="token comment">// 评论是否存在</span>
    <span class="token comment">// 是否是自己写的评论</span>
    <span class="token keyword">const</span> videodb <span class="token operator">=</span> <span class="token keyword">await</span> Video<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>video_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>videodb<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'error'</span><span class="token operator">:</span> <span class="token string">'视频不存在'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> commentdb <span class="token operator">=</span> <span class="token keyword">await</span> Comment<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>comment_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>commentdb<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'error'</span><span class="token operator">:</span> <span class="token string">'评论不存在'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>commentdb<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'error'</span><span class="token operator">:</span> <span class="token string">'评论不可删除'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> commentdb<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    videodb<span class="token punctuation">.</span>videoCount <span class="token operator">--</span> 
    <span class="token keyword">await</span> videodb<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'message'</span><span class="token operator">:</span> <span class="token string">'删除成功'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="视频评论列表"><a href="#视频评论列表" class="header-anchor">#</a> 视频评论列表</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">commentlist</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> video_id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>video_id
    <span class="token keyword">const</span> comment <span class="token operator">=</span> <span class="token keyword">await</span> Comment<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>video<span class="token operator">:</span> video_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'username image'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pageNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> Comment<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">{</span>video<span class="token operator">:</span> video_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="视频是否喜欢"><a href="#视频是否喜欢" class="header-anchor">#</a> 视频是否喜欢</h2> <ul><li>model层 videolikeModel.js 哪个用户对哪条视频是否喜欢</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> baseModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./baseModel'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> videolikeSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 关联users 集合</span>
        ref<span class="token operator">:</span> <span class="token string">'User'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    video<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 关联 videos 集合</span>
        ref<span class="token operator">:</span> <span class="token string">'Video'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    like<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Number<span class="token punctuation">,</span>
        <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>baseModel
<span class="token punctuation">}</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> videolikeSchema
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li>是否喜欢视频</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">videoLike</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id
    <span class="token keyword">const</span> video_id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>video_id
    <span class="token keyword">let</span> islike <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 1. 查找视频是否存在</span>
   <span class="token keyword">const</span> video <span class="token operator">=</span> <span class="token keyword">await</span> Video<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>video_id<span class="token punctuation">)</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>video<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'error'</span><span class="token operator">:</span> <span class="token string">'视频不存在'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">const</span> videodbBack <span class="token operator">=</span> <span class="token keyword">await</span> Videolike<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        user<span class="token punctuation">,</span>
        video<span class="token operator">:</span> video_id
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'videodbBack.like'</span><span class="token punctuation">,</span> videodbBack<span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>videodbBack <span class="token operator">&amp;&amp;</span> videodbBack<span class="token punctuation">.</span>like <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        videodbBack<span class="token punctuation">.</span>like <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword">await</span> videodbBack<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        islike <span class="token operator">=</span> <span class="token boolean">false</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>videodbBack <span class="token operator">&amp;&amp;</span> videodbBack<span class="token punctuation">.</span>like <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        videodbBack<span class="token punctuation">.</span>like <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">await</span> videodbBack<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">redisVideoHots</span><span class="token punctuation">(</span>video_id<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        islike <span class="token operator">=</span> <span class="token boolean">true</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Videolike</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            user<span class="token punctuation">,</span>
            video<span class="token operator">:</span> video_id<span class="token punctuation">,</span>
            like<span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        islike <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">redisVideoHots</span><span class="token punctuation">(</span>video_id<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   video<span class="token punctuation">.</span>likeCount <span class="token operator">=</span> <span class="token keyword">await</span> Videolike<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">{</span>video<span class="token operator">:</span> video_id<span class="token punctuation">,</span> like<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   video<span class="token punctuation">.</span>dislikeCount <span class="token operator">=</span> <span class="token keyword">await</span> Videolike<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">{</span>video<span class="token operator">:</span> video_id<span class="token punctuation">,</span> like<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token keyword">const</span> aa<span class="token operator">=</span> <span class="token keyword">await</span> video<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'aa'</span><span class="token punctuation">,</span> aa<span class="token punctuation">)</span>
   res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span>video<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> islike<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="vim-命令"><a href="#vim-命令" class="header-anchor">#</a> vim 命令</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> 搜索   <span class="token operator">/</span>xxx <span class="token operator">+</span> 回车  n 键下一个xxx
 插入字符   i 键
 写入   <span class="token operator">:</span>w
 退出   <span class="token operator">:</span>q
 显示行号 <span class="token operator">:</span><span class="token keyword">set</span> nu
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="redis-缓存"><a href="#redis-缓存" class="header-anchor">#</a> Redis 缓存</h2> <h3 id="命令-2"><a href="#命令-2" class="header-anchor">#</a> 命令</h3> <ul><li>redis-benchmark redis性能测试</li> <li>redis-check-rdb redis-check-aof 持久化存储工具</li> <li>redis-server 服务器指令</li> <li>redis-cli 命令行redis连接的一个客户端</li> <li>info server 查看redis 服务器信息</li> <li>info server 其中 <code>executable</code> 表示当前运行redis脚本的地方
<code>config_file</code> 表示当前运行redis的配置文件位置</li></ul> <h3 id="地址"><a href="#地址" class="header-anchor">#</a> 地址</h3> <ul><li>https://redis.io/docs/getting-started/installation/install-redis-on-mac-os</li></ul> <h3 id="redis-cli-客户端链接"><a href="#redis-cli-客户端链接" class="header-anchor">#</a> redis-cli 客户端链接</h3> <ul><li>keys *  查看存储的键</li> <li>redis-cli -h 127.0.0.1 -p 1234  指定链接和端口</li> <li>info server 查看服务器的运行状态</li></ul> <h3 id="redis-数据库"><a href="#redis-数据库" class="header-anchor">#</a> redis 数据库</h3> <ul><li>select （index）要跳转的库</li> <li>0 - 15 数据库</li> <li>默认存储在 0 号数据库</li> <li>各个数据库之间的数据不共享，但是不支持单独设置密码</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token keyword">set</span> age <span class="token number">1</span>    <span class="token comment">// 设置 s1 = 1</span>
    move s1 <span class="token number">12</span>  <span class="token comment">// 移动 s1到12号数据库</span>
    keys <span class="token operator">*</span>     <span class="token comment">// 查看存储的键</span>
    <span class="token keyword">get</span> age    <span class="token comment">// 获取 age 的值</span>
    <span class="token constant">MGET</span> s1 s2 <span class="token comment">// 获取多个值</span>
    <span class="token constant">MSET</span> s1 <span class="token number">1</span> s2 <span class="token number">2</span> <span class="token comment">// 一次设置多个值 s1 = 1 s2 = 2</span>
    <span class="token constant">GETSET</span> s1 <span class="token number">99</span> <span class="token comment">// 将给定的key的值设置为value，并且返回这个key之前的值</span>
    <span class="token constant">STRLEN</span> s1 <span class="token comment">// 获取键的长度</span>
    type s1 <span class="token comment">// 获取存值的类型</span>
    del s1 s2 <span class="token comment">// 删除多个值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="redis-数据类型"><a href="#redis-数据类型" class="header-anchor">#</a> redis 数据类型</h3> <ul><li>String 字符串，其他数据类型的基础类型</li> <li>Hash 散列， 是由与值相关的字段组成的内容，字段和值都是字符串</li> <li>List 列表，根据插入顺序排序的字符串元素的集合</li> <li>Set 未排序的字符串元素集合，集合中的数据是不重复的</li> <li>ZSet 与Set类似，但每个字符串元素都与一个数值的相关联。且按数值大小进行排序</li></ul> <h3 id="redis-键名"><a href="#redis-键名" class="header-anchor">#</a> redis 键名</h3> <ul><li>最大 512M</li></ul> <h3 id="哈希操作指令"><a href="#哈希操作指令" class="header-anchor">#</a> 哈希操作指令</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token constant">HSET</span> hash h1 <span class="token number">1</span> h2 <span class="token number">2</span> h3 <span class="token number">3</span> <span class="token comment">// 设置hash返回存储的长度 - (integer) 3</span>
 
<span class="token constant">HKEYS</span> hash 查看hash 存储
<span class="token constant">HLEN</span> hash 获取 hash长度
<span class="token constant">HGET</span> hash h1 获取hash值 
<span class="token constant">HMGET</span> hash h1 h2 获取多个hash值
<span class="token constant">HGETALL</span> hash  <span class="token comment">// 获取整个hash值</span>
<span class="token constant">HSET</span> hash h1 <span class="token number">66</span> <span class="token comment">//修改 h1 的值</span>
<span class="token constant">HDEL</span> hash h2  <span class="token comment">// 删除 h2</span>
<span class="token constant">HGETALL</span> hash <span class="token comment">//删除所有 hash</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="redis列表"><a href="#redis列表" class="header-anchor">#</a> Redis列表</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">LPUSH</span> l1 <span class="token number">11</span> <span class="token number">22</span> <span class="token number">33</span>  <span class="token comment">// 在列表l1 里添加三个值</span>
<span class="token constant">LRANGE</span> l1 <span class="token number">0</span> <span class="token number">3</span>  <span class="token comment">// 获取 l1 列表 0 - 3 的值</span>
<span class="token constant">LINSERT</span> l1 before <span class="token number">33</span> <span class="token number">00</span> <span class="token comment">// 在 33 之前插入 00</span>
<span class="token constant">LINSERT</span> l1 after <span class="token number">33</span> <span class="token number">00</span> <span class="token comment">// 在 33 之后插入 00</span>
<span class="token constant">LINDEX</span> l1  <span class="token number">3</span>  <span class="token comment">// 获取某一个位置的值</span>
<span class="token constant">LLEN</span> l1 <span class="token comment">// 获取列表的长度</span>
<span class="token constant">LPOP</span> l1 <span class="token comment">// 删除列表第一个元素 并返回删除的元素</span>
<span class="token constant">RPOP</span> l1 <span class="token comment">// 删除列表最后一个元素 并返回删除的元素</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="redis-集合"><a href="#redis-集合" class="header-anchor">#</a> Redis 集合</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token constant">SADD</span> s21 <span class="token number">11</span> <span class="token number">22</span> <span class="token number">33</span> <span class="token comment">// 在s21集合中添加三个值</span>
 <span class="token constant">SMEMBERS</span> s21  <span class="token comment">// 显示s21 集合中的全部数据</span>
 <span class="token constant">SCARD</span> s21   <span class="token comment">// 获取s21 集合中的成员个数</span>
 <span class="token constant">SRANDMEMBER</span> s21 <span class="token comment">// 获取s21 集合中的随机值</span>
 <span class="token constant">SRANDMEMBER</span> s21 <span class="token number">2</span> <span class="token comment">// 获取s21 集合中的2个随机值</span>
 <span class="token constant">SREM</span> s21 <span class="token number">11</span>   <span class="token comment">// 删除 s21 集合中的 11 成员</span>
 <span class="token constant">SPOP</span> s21    <span class="token comment">// 随机删除 s21 中的成员</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="redis-有序集合"><a href="#redis-有序集合" class="header-anchor">#</a> Redis 有序集合</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ZADD</span> z1  <span class="token number">5</span> u1 <span class="token number">6</span> u2 <span class="token number">66</span> u3 <span class="token number">44</span> u4 <span class="token number">55</span> u5  <span class="token comment">// z1(集合的名字) 5 集合的值，u1 值的名字</span>

<span class="token constant">ZRANGE</span> z1  <span class="token number">3</span> <span class="token number">99</span> <span class="token comment">// 获取3-99位置的有序集合（从低到高）</span>
<span class="token constant">ZREVRANGE</span> z1  <span class="token number">3</span> <span class="token number">99</span> <span class="token comment">// 获取3-99位置的有序集合（从高到低）</span>
zrank z1 u2    <span class="token comment">// 获取z1集合 u2 的排名 （从0开始的排名 - 从低到高）</span>

<span class="token constant">ZREVEANK</span> z1 u4 <span class="token comment">// z1集合从高到低的排名</span>

<span class="token constant">ZCARD</span> z1   <span class="token comment">// 获取z1成员数</span>

zincrby  z1 <span class="token number">3</span> u2   <span class="token comment">// 在原有值的基础上增加指定的增量(6+3 = 9)</span>

<span class="token constant">ZREM</span> z1 u2    <span class="token comment">// 删除有序集合z1中 的 u2值</span>
<span class="token constant">RNAME</span> z1 zz   <span class="token comment">// 把z1 键改为zz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="redis-密码"><a href="#redis-密码" class="header-anchor">#</a> Redis 密码</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 获取密码，默认无密</span>
<span class="token constant">CONFIG</span> <span class="token constant">GET</span> requirepass
<span class="token comment">// 设置密码为root</span>
<span class="token constant">CONFIG</span> <span class="token constant">SET</span> requirepass root
<span class="token comment">// 设置密码后连接redis-cli</span>
redis<span class="token operator">-</span>cli <span class="token operator">-</span>a root
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="redis-config-配置"><a href="#redis-config-配置" class="header-anchor">#</a> Redis config 配置</h3> <blockquote><p>redis 默认为安全模式，需要先添加密码，然后允许客户端连接redis</p></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token comment">// 1. 连接redis-cli 输入命令查看redis.config 安装目录</span>
  info server
  
<span class="token comment">// 2. vim 打开config目录 </span>
  vim <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
  
<span class="token comment">// 3. 输入 /bind 搜索 到bind 127.0.0.1 ::1 在下面添加一行允许客户端连接redis</span>
bind <span class="token operator">*</span>

<span class="token comment">// 4. 给redis添加密码 搜索requirepass，在下面添加一行</span>
 requirepass root
 
<span class="token comment">// 5. 写入并退出</span>
    <span class="token operator">:</span>wq
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="使用node操作redis"><a href="#使用node操作redis" class="header-anchor">#</a> 使用Node操作Redis</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ioredis'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">,</span> <span class="token string">'192.168.1.2'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'mykey'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span>
redis<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="热度排名案例"><a href="#热度排名案例" class="header-anchor">#</a> 热度排名案例</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ioredis'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">,</span> <span class="token string">'192.168.1.2'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> num <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">30</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">'asdfghjklqw'</span> 
<span class="token keyword">let</span> strindex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">11</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> collection_name <span class="token operator">=</span> <span class="token string">'hots'</span>
<span class="token keyword">const</span> <span class="token function-variable function">hots</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查看当前的有序集合 key 是否存在</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">zscore</span><span class="token punctuation">(</span>collection_name<span class="token punctuation">,</span> str<span class="token punctuation">[</span>strindex<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 存在 让key的值加1</span>
        <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">zincrby</span><span class="token punctuation">(</span>collection_name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> str<span class="token punctuation">[</span>strindex<span class="token punctuation">]</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>strindex<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'+ 1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">// 不存在  添加到有序集合</span>
        <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span>collection_name<span class="token punctuation">,</span> num<span class="token punctuation">,</span>  str<span class="token punctuation">[</span>strindex<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">// 从高到低排序，并显示值</span>
  <span class="token keyword">const</span> paixu <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">zrevrange</span><span class="token punctuation">(</span>collection_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'withscores'</span><span class="token punctuation">)</span>
    <span class="token comment">// 组合为key value形式</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> paixu<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            obj<span class="token punctuation">[</span>paixu<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> paixu<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">hots</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="相关地址"><a href="#相关地址" class="header-anchor">#</a> 相关地址</h3> <p>https://redis.io/docs/clients/#nodejs
https://github.com/luin/ioredis
https://redis.io/docs/getting-started/installation/install-redis-on-linux/</p> <h2 id="视频收藏功能实现"><a href="#视频收藏功能实现" class="header-anchor">#</a> 视频收藏功能实现</h2> <ul><li>新建model collectionModel.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> videoCollectSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 关联users 集合</span>
        ref<span class="token operator">:</span> <span class="token string">'User'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    video<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 关联 videos 集合</span>
        ref<span class="token operator">:</span> <span class="token string">'Video'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>baseModel
<span class="token punctuation">}</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> videoCollectSchema
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>视频收藏实现 videoController.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">collect</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> video_id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>video_id
    <span class="token keyword">const</span> user_id <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id
    <span class="token comment">// 1. 判断视频是否存在</span>
   <span class="token keyword">const</span> dbvideo <span class="token operator">=</span> <span class="token keyword">await</span> Video<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>video_id<span class="token punctuation">)</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dbvideo<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'error'</span><span class="token operator">:</span> <span class="token string">'视频不存在'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 2. 视频是否已收藏</span>
  <span class="token keyword">const</span> iscollect <span class="token operator">=</span> <span class="token keyword">await</span> Collect<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    video<span class="token operator">:</span> video_id<span class="token punctuation">,</span>
    user<span class="token operator">:</span> user_id
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>iscollect<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'error'</span><span class="token operator">:</span> <span class="token string">'视频已收藏'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 3. 未收藏</span>
   <span class="token keyword">const</span> collect <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Collect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    video<span class="token operator">:</span> video_id<span class="token punctuation">,</span>
    user<span class="token operator">:</span> user_id
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">redisVideoHots</span><span class="token punctuation">(</span>video_id<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
   res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="实现视频热门推荐机制"><a href="#实现视频热门推荐机制" class="header-anchor">#</a> 实现视频热门推荐机制</h2> <ul><li>连接redis  model/reids/index.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ioredis'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">,</span> <span class="token string">'192.168.1.2'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

redis<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'redis连接错误'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
redis<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'redis 连接成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
exports<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>redis 添加视频热度及获取视频热度</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>redis<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./index'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> redis_hots_name <span class="token operator">=</span> <span class="token string">'hotsname'</span>
<span class="token comment">/**
 * 
 * @param {*} videoid 视频id
 * @param {*} num 热度值
 */</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">redisVideoHots</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">videoid<span class="token punctuation">,</span> num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">zscore</span><span class="token punctuation">(</span>redis_hots_name<span class="token punctuation">,</span> videoid<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> hots <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">zincrby</span><span class="token punctuation">(</span>redis_hots_name<span class="token punctuation">,</span> num<span class="token punctuation">,</span> videoid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> hots <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span>redis_hots_name<span class="token punctuation">,</span> num<span class="token punctuation">,</span> videoid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> hots
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 
 * @param {*} num 获取条数
 */</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">getRedisVideoHots</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hots <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">zrevrange</span><span class="token punctuation">(</span>redis_hots_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'withscores'</span><span class="token punctuation">)</span>
    <span class="token comment">// redis 键 值是在一起的，所以需要 * 2</span>
    <span class="token keyword">const</span> video_hots <span class="token operator">=</span> hots<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> num <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> video_hots<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// [f,1,g,0,k,8] 偶数下标为键 奇数下标为值</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            obj<span class="token punctuation">[</span>video_hots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> video_hots<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> obj
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li>定义热度权重，设置视频热度值</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 观看 +1 点赞 +2 评论 +2 收藏 +3</span>
 <span class="token function">redisVideoHots</span><span class="token punctuation">(</span>video_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>获取热度值</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">getVideoHots</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> num <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>num
    <span class="token keyword">const</span> hotlist <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRedisVideoHots</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>hotlist<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="unbantu"><a href="#unbantu" class="header-anchor">#</a> unbantu</h2> <h3 id="安装node"><a href="#安装node" class="header-anchor">#</a> 安装node</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>curl <span class="token operator">-</span>fsSL https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>deb<span class="token punctuation">.</span>nodesource<span class="token punctuation">.</span>com<span class="token operator">/</span>setup_16<span class="token punctuation">.</span>x <span class="token operator">|</span> sudo <span class="token operator">-</span><span class="token constant">E</span> bash <span class="token operator">-</span> <span class="token operator">&amp;&amp;</span>\
sudo apt<span class="token operator">-</span><span class="token keyword">get</span> install <span class="token operator">-</span>y nodejs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="nginx-反向代理与负载均衡"><a href="#nginx-反向代理与负载均衡" class="header-anchor">#</a> nginx 反向代理与负载均衡</h2> <blockquote><p>nginx 是一个高性能的http服务的软件，具有非常好的高并发的处理能力，也支持反向代理与负载均衡</p></blockquote> <h3 id="nginx-安装与基本使用"><a href="#nginx-安装与基本使用" class="header-anchor">#</a> nginx 安装与基本使用</h3> <h4 id="安装-5"><a href="#安装-5" class="header-anchor">#</a> 安装</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>sudo apt<span class="token operator">-</span><span class="token keyword">get</span> install nginx
<span class="token comment">// 可执行的nginx 放在</span>
cd <span class="token operator">/</span>usr<span class="token operator">/</span>share

<span class="token comment">// nginx.conf 配置文件在</span>
cd <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>

<span class="token comment">// nginx日志文件</span>
cd <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx

<span class="token comment">// access.log  nginx 接收到的请求日志</span>
<span class="token comment">// error.log   nginx 接收到的错误日志</span>

<span class="token comment">// 查看 nginx 占用端口</span>
sudo netstat <span class="token operator">-</span>tupln <span class="token operator">|</span> grep <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="nginx-工作模型"><a href="#nginx-工作模型" class="header-anchor">#</a> nginx 工作模型</h3> <figure class="third"><img src="/blog/img/node/nginx_mode.jpg" width="400px"></figure> <ul><li>master 主进程 只负责接收客户端发来的请求，自身不处理，之后分配给子进程，如果当前子进程工作饱和，会再开启一个子进程，这样可以应对并发量</li></ul> <h3 id="nginx-命令"><a href="#nginx-命令" class="header-anchor">#</a> nginx 命令</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 停止</span>
nginx <span class="token operator">-</span>s stop
<span class="token comment">// 开启</span>
nginx

<span class="token comment">// 停止</span>
nginx <span class="token operator">-</span>s quit

<span class="token operator">!</span> quit 与 stop 的区别
quit：优雅停止 所有子进程全部执行完毕后，才会销毁进程，停止服务，如果再有请求进来也不会接收
stop：立即停止 无论什么情况，直接停止服务
建议使用quit

<span class="token comment">// 重新记录日志位置（当修改日志文件夹名字后日志还会记录在原先的文件夹中，因为nginx在查找文件时，不是按照文件夹名找的，而是按照文件的位置，类似于js中的引用类型）</span>
nginx <span class="token operator">-</span>s reopen

<span class="token comment">// 验证配置文件的正确性</span>
nginx <span class="token operator">-</span>t

<span class="token comment">// 改变配置文件后不希望服务立刻停止，而是新的请求进来后再请求新的配置文件</span>
nginx <span class="token operator">-</span>s reload

<span class="token comment">// 查看 nginx 指令</span>
nginx <span class="token operator">-</span>h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="nginx-配置文件"><a href="#nginx-配置文件" class="header-anchor">#</a> nginx 配置文件</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>Main  <span class="token comment">// 全局配置区，Nginx 核心功能配置</span>

<span class="token comment">// Main 区域</span>
user www<span class="token operator">-</span>data<span class="token punctuation">;</span> 在启动nginx时，他是用哪一个系统下的账户启动的

worker_processes auto  允许开启的worker数量 auto 根据操作系统配置，通常会设置成cpu的数量相等

pid <span class="token operator">/</span>run<span class="token operator">/</span>nginx<span class="token punctuation">.</span>pid  每一个nginx 启动都会占用一个pid

include 引入配置文件

events<span class="token punctuation">{</span> <span class="token comment">// events 事件区 子进程核心配置</span>
    worker_connections <span class="token number">768</span><span class="token punctuation">;</span> <span class="token comment">// 每一个worker支持的最大连接数，每一个worker 最大可以打开768个链接，也就是处理768个并发数，也可以理解为每一个worker子进程可以处理768个客户端请求，理论最大支持65535，也就是2的16次方减一</span>
<span class="token punctuation">}</span> 

http <span class="token punctuation">{</span> <span class="token comment">// http  服务器配置区</span>
    
    sendfile on<span class="token punctuation">;</span> <span class="token comment">// 要不要让nginx去调用系统的sendfile函数来输出文件</span>
    
    tcp_nopush on<span class="token punctuation">;</span>
    tcp_nodelay on<span class="token punctuation">;</span> 这个和上一个需要配合使用，nginx在处理链接的时候，处理的数据包会不会累计，如果是on则会累积一起传输，提高传输效率<span class="token punctuation">,</span>后一个的含义是 最小数据包是否等待
    
 keepalive_timeout <span class="token number">65</span>  <span class="token comment">// 一个交互最长的断开时间，如果65s之内有请求，链接则保持</span>
 
 include <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>mime<span class="token punctuation">.</span>types；
 dfault_type application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span> <span class="token comment">// 如果在mime.types文件中没有找到，则统一使用application/octet-stream二进制流的形式做返回</span>
 
 <span class="token comment">// nginx日志文件 nginx -s reload 重新记录日志文件</span>
 access_log <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log
 error_log <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>error<span class="token punctuation">.</span>log 
   
   gzip on<span class="token punctuation">;</span> <span class="token comment">// 默认开启 gzip</span>
   
   include <span class="token operator">/</span>ect<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token comment">/*.cond;
   include /ect/nginx/sites-enabled/*;
   // sites-enabled/default 中
   server {
    listen 80 default_server; //nginx 默认启动 80端口
    root /var/www/html; nginx启动后接到请求，worker处理时，nginx返回给客户端的路径文件地址
    
    index index.html index.htm index.nginx-cebian.html //找/var/www/html文件夹下的index 文件，优先选择.html
    location /{ // location 请求路径配置 斜杠/ 请求的路径为根路径
     proxy_pass http://127.0.0.1:3000; // 反向代理 代理到3000端口
    
    }
   }
    ---------------------------------
    server { // 不同服务配置区
        location { // location 不同请求路径配置区
            // 具体配置项
        }
    }
}

mail { // 邮件代理配置区
    server { // 邮件服务配置区
        // 具体配置项
    }
}
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="nginx-反向代理"><a href="#nginx-反向代理" class="header-anchor">#</a> nginx 反向代理</h3> <figure class="third"><img src="/blog/img/node/nginx_proxy.jpg" width="400px"></figure> <ul><li>外部客户端 通过网关访问内网服务器的内容，网关起到了反向代理的作用，内网服务器不提供对外服务，客户端直接访问内网服务器是不允许的，nginx相当于网关的作用，nginx去代理这些服务器</li></ul> <h2 id="https-配置"><a href="#https-配置" class="header-anchor">#</a> https 配置</h2> <p>在http的基础上多了一个加密层，http是明文传输，https是在明文传输的过程中，将数据进行认证加密，保证通信安全</p> <ul><li>申请证书</li> <li>sites-enabled/default 中</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>server <span class="token punctuation">{</span>
    listen <span class="token number">443</span> ssl<span class="token punctuation">;</span>
    server_name www<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">;</span> 
    ssl_certificate <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>x<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>
    ssl_certificate_key <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>x<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="项目完整地址"><a href="#项目完整地址" class="header-anchor">#</a> 项目完整地址</h2> <p>https://github.com/Dave-SEO/node-express.git</p> <h2 id="自定义脚手架的实现"><a href="#自定义脚手架的实现" class="header-anchor">#</a> 自定义脚手架的实现</h2> <h3 id="创建自定义全局指令"><a href="#创建自定义全局指令" class="header-anchor">#</a> 创建自定义全局指令</h3> <ul><li>根目录下创建 bin/cli.js</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token comment">// 指定用node执行脚本文件</span>
 #<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>npm init</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 创建bin/cli.js后会自动在package文件中生成bin配置</span>
 <span class="token string">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token string">&quot;cli&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bin/cli.js&quot;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="使用commander处理help选项及自定义"><a href="#使用commander处理help选项及自定义" class="header-anchor">#</a> 使用commander处理help选项及自定义</h3> <ul><li>安装commander</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// https://www.npmjs.com/package/commander</span>
 npm i commander
 
  <span class="token keyword">const</span> <span class="token punctuation">{</span>program<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span>
  program<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-f --framwork &lt;framwork&gt;'</span><span class="token punctuation">,</span> <span class="token string">'设置框架'</span><span class="token punctuation">)</span>
  program<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 命令行执行</span>
  mycli <span class="token operator">-</span>f xxx
  mycli <span class="token operator">--</span>help
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>commander 自定义命令
mycli create xxx</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>   <span class="token keyword">const</span> <span class="token punctuation">{</span>program<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span>
   program<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'create &lt;project&gt; [other...]'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">'crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'创建项目'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">project<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 接收xxx文件名</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span>
    <span class="token comment">// 接收参数</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>npm 地址
https://github.com/tj/commander.js</li></ul> <h3 id="命令行问答交互-inquirer-js"><a href="#命令行问答交互-inquirer-js" class="header-anchor">#</a> 命令行问答交互(inquirer.js)</h3> <ul><li>安装 inquirer</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>   npm install <span class="token operator">--</span>save inquirer@<span class="token operator">^</span><span class="token number">8.0</span><span class="token number">.0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>使用</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> inquirer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'inquirer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
       <span class="token punctuation">{</span>
           type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
           name<span class="token operator">:</span> <span class="token string">'framwork'</span><span class="token punctuation">,</span>
           choices<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'express'</span><span class="token punctuation">,</span> <span class="token string">'koa'</span><span class="token punctuation">,</span> <span class="token string">'egg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
           message<span class="token operator">:</span> <span class="token string">'请选择你要使用的框架'</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">answers</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>answers<span class="token punctuation">)</span>
       <span class="token comment">// Use user feedback for... whatever!!</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>isTtyError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// Prompt couldn't be rendered in the current environment</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token comment">// Something else went wrong</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>npm 地址
https://www.npmjs.com/package/inquirer</li></ul> <h3 id="下载远程仓库模版代码-download-git-repo"><a href="#下载远程仓库模版代码-download-git-repo" class="header-anchor">#</a> 下载远程仓库模版代码(download-git-repo)</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>   <span class="token keyword">const</span> download <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'download-git-repo'</span><span class="token punctuation">)</span>
   <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'gitee地址'</span>
   <span class="token keyword">const</span> dir <span class="token operator">=</span> <span class="token string">'xxx'</span>
   <span class="token function">download</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">direct:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> dir<span class="token punctuation">,</span> <span class="token punctuation">{</span> clone<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>npm 地址
https://www.npmjs.com/package/download-git-repo</li></ul> <h3 id="下载等待提示交互-ora"><a href="#下载等待提示交互-ora" class="header-anchor">#</a> 下载等待提示交互(ora)</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>   <span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span>
   <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   spinner<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   spinner<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">'yellow'</span><span class="token punctuation">;</span>
   spinner<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">'下载中...'</span><span class="token punctuation">;</span>
   spinner<span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span><span class="token string">'下载完成'</span><span class="token punctuation">)</span>
   spinner<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'下载失败'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>npm地址
https://www.npmjs.com/package/ora</li></ul> <h3 id="命令行样式渲染工具-chalk"><a href="#命令行样式渲染工具-chalk" class="header-anchor">#</a> 命令行样式渲染工具(chalk)</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span>
<span class="token comment">// 粗体绿色</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span>bold<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'npm install'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>npm 地址
https://www.npmjs.com/package/chalk</li></ul> <h3 id="项目地址"><a href="#项目地址" class="header-anchor">#</a> 项目地址</h3> <p>https://github.com/Dave-SEO/mycli.git</p> <h2 id="将自己的脚手架工具发布到npm"><a href="#将自己的脚手架工具发布到npm" class="header-anchor">#</a> 将自己的脚手架工具发布到npm</h2> <p>发布镜像源npm地址必须是npm官网</p> <ul><li>以json格式展示配置文件列表</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>npm config list <span class="token operator">-</span>l <span class="token operator">--</span>json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>设置镜像源</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> npm config <span class="token keyword">set</span> registry https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>registry<span class="token punctuation">.</span>npmjs<span class="token punctuation">.</span>org
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>登陆</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>npm login
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>更新项目版本号</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">// 最后一位自动加一</span>
    npm version patch
    <span class="token comment">// 中间一位自动加一</span>
    npm version minor
    <span class="token comment">// 第一位加一</span>
    npm version major
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>发布 包名不能是已经存在的名字(在npm上)</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>npm publish
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>使用  全局安装发布后的脚手架</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>npm install <span class="token operator">-</span>g xxx
xxx <span class="token operator">-</span>h <span class="token comment">// 帮助命令</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></div> <footer class="page-edit" style="display:none;"><div class="edit-link"><a href="https://github.com/Dave-SEO/blog/edit/master/docs/views/nodejs/nodejs从0到1.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> <!----> <div class="article-list" data-v-2af88190><div class="article-title" data-v-2af88190><a href="/blog/timeline/" class="iconfont icon-shizhong" data-v-2af88190>最近更新</a></div> <div class="article-wrapper" data-v-2af88190><dl data-v-2af88190><dd data-v-2af88190>01</dd> <dt data-v-2af88190><a href="/blog/views/mianshi/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95.html" data-v-2af88190><div data-v-2af88190>前端面试(一)</div></a> <span data-v-2af88190>03-30</span></dt></dl><dl data-v-2af88190><dd data-v-2af88190>02</dd> <dt data-v-2af88190><a href="/blog/views/JavaScript/JavaScript%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1.html" data-v-2af88190><div data-v-2af88190>JavaScript 知识图谱</div></a> <span data-v-2af88190>03-11</span></dt></dl><dl data-v-2af88190><dd data-v-2af88190>03</dd> <dt data-v-2af88190><a href="/blog/views/react/React+TypeScript+AntDesign.html" data-v-2af88190><div data-v-2af88190>使用React + TypeScript + Ant Design 笔记</div></a> <span data-v-2af88190>03-05</span></dt></dl></div> <div data-v-2af88190><a href="/blog/timeline/" class="article-more" data-v-2af88190>更多文章 &gt;</a></div></div></main> <!----> <div class="comments-wrapper" style="display:none;" data-v-584a622c><div class="valine-wrapper"><div id="valine"></div></div></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-566b5166 data-v-566b5166><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-566b5166><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-566b5166></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-566b5166></path></svg></div><!----><div data-v-48108b4c><div class="DetailsOpenFlag" style="right:1rem;bottom:9rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;font-size:14px;font-weight:500;display:none;" data-v-48108b4c>
 展开 

</div></div><div id="musicPlayer" data-v-647473e2><!----> <div class="bbox" data-v-647473e2><div class="pan" style="background-image:url(/blog/assets/img/pan.07613e22.png);" data-v-647473e2><img src="" alt class="pan_c" data-v-647473e2></div> <div class="box" style="background-image:url();" data-v-647473e2><div class="music_shlter_2" style="background-image:url();" data-v-647473e2></div> <div class="music_shlter" style="background-image:url();" data-v-647473e2></div> <div class="music_shlter_3" data-v-647473e2></div> <div class="music_dis" data-v-647473e2><div class="dis_list" data-v-647473e2>···</div> <p class="music_title" data-v-647473e2></p> <p class="music_intro" data-v-647473e2>歌手: </p> <ul class="music_words" data-v-647473e2><div class="music_words_box" style="top:0px;" data-v-647473e2></div></ul></div> <div class="control_box" data-v-647473e2><div class="control_button" data-v-647473e2><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHAAAACMCAYAAACksC0pAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAALjSURBVHhe7doxbuswFETRSG68pVTZ+y+SJdmVE/GDC0hzBxnynoqpBGhIaoy84/vyBnu9Xv9ut9vH/HN5j8fj836/v88/Mc/n8+uca9RxHPgm2VUkwN2kNux4TiTA65Y+5nIL53m+5hI1nuMJLGeAgKu0xW42AwQEiv1/10bJBLhhC0198z2BBFtoueUC3I0BlkvdOLZQyGiHc4myhXJsoc2CG9YWSkgFeJ6nJYZgCy1nCy23XIC7tVBPYL/YhjVAwGiHc4mK/Uc+daX8FbZQ/YrfQEhqpGIwQEDqkzE2SiTA3X5GJHkCAcuVmN1aqIO95ZIb1gABqQD9GQG5XuxcsRyp4KSuUE8gwRZabrkAd2OA5Wyh5Rzs7WcLbRbcsLZQQipAB3shttByttByywW4Wwv1BPaLbVgDBDjYW84WWs5vYLnkjWOAgFSADvYuwBMISG1YWyhkvNi5RNlCIZaYcqkAx3MMEHC92LliOVLBSV2hnkBCasPGSowtlGELLWeAEFtoOQd7+9lCmwU3rC2UkApwjG54AgGpAG2hEFtoueUC3K2FegL7xTasAQJGO5xLlCMVEFtoOb+B5ZI3jgECUgE62LsATyAgtWFtoRBHKspZYsqlAhzPMUDA9WLniuVIBSd1hXoCCakNGysxtlCGLbScAUJsoeUc7O1nC20W3LC2UEIqwDG64QkEpAK0hUJsoeWWC3C3FuoJ7BfbsAYIGO1wLlGOVEBsoeX8BpZL3jgGCEgF6GDvAjyBgOVKzG4tNDVSEfsZsRtLTLlUgOM5Bgi4XuxcsRyp4KSuUE8gwRZabrkAd2OA5Wyh5Rzs7WcLbRbcsLZQQipAB3shttByttByywW4Wwv1BPaLbVgDBDjYW84Wql/xGwgZ85pziTNAQOqT4WDvAjyBgOVKzG4t1MHecskNa4CAVID+jIBcL3auWI5UcFJXqCeQYAstt1yAuzHAcrbQcg729rOFNstt2LfvHxY+GuRFc4rhAAAAAElFTkSuQmCC" alt class="control_icon" data-v-647473e2></div> <div class="progress" data-v-647473e2><div class="progress_c" style="width:0%;" data-v-647473e2><div class="progress_circle" data-v-647473e2><div class="progress_circle_c" data-v-647473e2></div></div></div></div></div></div> <video id="music" autoplay="autoplay" src="" name="media" data-v-647473e2></video></div></div></div></div>
    <script src="/blog/assets/js/app.396e683c.js" defer></script><script src="/blog/assets/js/5.e2f1812c.js" defer></script><script src="/blog/assets/js/1.f0d29b0d.js" defer></script><script src="/blog/assets/js/2.c2276c40.js" defer></script><script src="/blog/assets/js/70.3cff71b8.js" defer></script><script src="/blog/assets/js/20.fc7d5e78.js" defer></script>
  </body>
</html>
